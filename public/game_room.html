<html>
<head>
    <title> Web RTS Front End </title>
</head>
<body>

    <div id="game_info">
        <p id="name"></p>
        <br>
        <table id="player_info">
        </table>
        <p> Ready? <input type="checkbox" id="ready_check"></p>
        <button id="leave_room"> Leave Room </button>
        <button id="start_game"> Start Game</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>
        var socket = io();

        $(document).ready(function(){
            let game_json = sessionStorage.getItem('game');
            let game = JSON.parse(game_json);
            socket.emit('get_game', game_json);
            socket.emit('join io room', game_json);
        });

        $('#leave_room').on('click', function(){
            socket.emit('leave_room', sessionStorage.getItem('game'), sessionStorage.getItem('player'));
            window.location.href = "index.html";
        });

        $('#start_game').on('click', function(){
            /* Steps to Have Players in same game:
             * 1. Check to see if both players are ready
             * 2. establish a webrtc connection between two players
             * 3. move both players to game.html
             * 4. give both players a copy of the game
             * 5. have both players send, updates to each other every game tick
             *       so as to have identical game state
             */
            socket.emit('check game ready', sessionStorage.getItem('game'));
        });

        $('#ready_check').change(function(){
            let player = JSON.parse(sessionStorage.getItem('player'));
            player.isReady = this.checked;
            let player_json = JSON.stringify(player);
            sessionStorage.setItem('player', player_json);
            socket.emit('update_player', sessionStorage.getItem('game'), sessionStorage.getItem('player'));
        });

        socket.on('update game', function(game_json){
            sessionStorage.setItem('game', game_json);
            updateGameHTML();
        });

        socket.on('start game', function (game) {
            alert('start game succeeded');
        });

        socket.on('start game failed', function () {
           alert('start game failed');
        });

        function updateGameHTML() {
            let game = JSON.parse(sessionStorage.getItem('game'));
            $('#name').text(game.id);
            $('#player_info tr').remove();
            $('#player_info').append("<tr> <th> Player </th> <th> Ready Status </th> </tr>");
            for (let i = 0; i < game.players.length; i++) {
                $('#player_info').append("<tr> <td>" + game.players[i].id + "</td> <td>" + game.players[i].isReady + "</th> </tr>");
            }
        }
    </script>
</body>
</html>
